configurations.all {
	resolutionStrategy {
		force 'xml-apis:xml-apis:1.4.01'
	}
}

allprojects {
	apply plugin: 'jacoco'

	clean {
		delete 'out'
	}

	check {
		dependsOn checkSourceFormatting
	}
}

configure(subprojects.findAll {!it.childProjects}) {
	sourceCompatibility = "1.8"
	targetCompatibility = "1.8"

	task copyJacocoAgent(type: Copy) {
		from {
			zipTree(configurations.jacocoAgent.singleFile)
		}

		into "${rootDir}/build/jacoco"
	}

	check {
		dependsOn subprojects.findAll {!it.childProjects}.copyJacocoAgent
	}

	configurations {
		framework
		whiteboard

		framework.extendsFrom runtime
		compileOnly.extendsFrom whiteboard
	}

	test {
		ignoreFailures = false
	}

	setUpTestableTomcat {
		enabled = false
	}

	startTestableTomcat {
		enabled = false
	}

	stopTestableTomcat {
		enabled = false
	}
}

task codeCoverageReport(type: JacocoReport) {
	executionData fileTree(project.rootDir.absolutePath).include("**/build/jacoco/*.exec")

	subprojects.findAll { !it.childProjects }.each {
		sourceSets it.sourceSets.main
	}

	reports {
		xml.enabled true
		xml.destination "${buildDir}/reports/jacoco/report.xml"
		html.enabled false
		csv.enabled false
	}
}